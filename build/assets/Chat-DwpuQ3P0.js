import{r as s,u as G,e as ne,l as re,j as e,n as N,o as k,p as B,q as oe,t as ae,v as ie,a as le,w as ce,d as ue,x as de,C as me,y as ge,z as pe,A as fe,S as D,g as he,T as xe,I as je,B as ye,D as V,E as H,F as O,H as Ce}from"./index-BmBvUYam.js";import{u as Se,I as z}from"./index-DjVLi6pA.js";import{Image as Me,AudioFile as ke,VideoFile as be,UploadFile as ve,AttachFile as Ae,Send as Te}from"@mui/icons-material";import{M as Fe,a as we}from"./Menu-v_V5_JOT.js";import{M as A,L as T}from"./MenuItem-XPjFVzgt.js";import{T as F,B as Le,b as Re,a as Ee}from"./hook-BfoxiVHU.js";import{m as Ie,A as _e}from"./Applayout-D8MYJ3LL.js";import{A as $e}from"./Attachments-B2d84hmj.js";import{T as L}from"./Typography-CKxAtiXl.js";import"./AvatarCard-afY2Tilm.js";import"./Avatar-vsw6e8ON.js";import"./Toolbar-Dix1PW1-.js";const Be=({anchorE1:t,chatId:c})=>{const i=s.useRef(null),u=s.useRef(null),d=s.useRef(null),j=s.useRef(null),a=G(),{isFileMenu:p}=ne(n=>n.misc),[f]=re(),g=()=>a(N(!1)),m=n=>{var l;(l=n.current)==null||l.click()},o=async(n,l)=>{const y=Array.from(n.target.files);if(y.length<=0)return;if(y.length>5)return k.error(`You can Only send 5 ${l} at a time`);a(B(!0));const C=k.loading(`Sending ${l}...`);g();try{const h=new FormData;h.append("chatId",c),console.log(y),y.forEach(b=>{console.log("Appending file:",b),h.append("files",b)}),(await f(h)).data?k.success(`${l} sent Successfully`,{id:C}):k.error(`Failed to send ${l}`,{id:C})}catch(h){k.error(h,{id:C})}finally{a(B(!1))}};return e.jsx(Fe,{open:p,anchorEl:t,onClose:g,children:e.jsx("div",{style:{width:"10rem"},children:e.jsxs(we,{children:[e.jsxs(A,{onClick:()=>m(i),children:[e.jsx(F,{title:"Image",children:e.jsx(Me,{})}),e.jsx(T,{style:{marginLeft:"0.5rem"},children:"Image"}),e.jsx("input",{type:"file",multiple:!0,accept:"image/png,image/jpeg,image/gif",style:{display:"none"},onChange:n=>o(n,"Images"),ref:i})]}),e.jsxs(A,{onClick:()=>m(u),children:[e.jsx(F,{title:"Audio",children:e.jsx(ke,{})}),e.jsx(T,{style:{marginLeft:"0.5rem"},children:"Audio"}),e.jsx("input",{type:"file",multiple:!0,accept:"audio/mpeg, audio/wav, audio/ogg",style:{display:"none"},onChange:n=>o(n,"Audios"),ref:u})]}),e.jsxs(A,{onClick:()=>m(d),children:[e.jsx(F,{title:"Video",children:e.jsx(be,{})}),e.jsx(T,{style:{marginLeft:"0.5rem"},children:"Video"}),e.jsx("input",{type:"file",multiple:!0,accept:"video/mp4 , video/webm , video/ogg",style:{display:"none"},onChange:n=>o(n,"Videos"),ref:d})]}),e.jsxs(A,{onClick:()=>m(j),children:[e.jsx(F,{title:"File",children:e.jsx(ve,{})}),e.jsx(T,{style:{marginLeft:"0.5rem"},children:"File"}),e.jsx("input",{type:"file",multiple:!0,accept:"*",style:{display:"none"},onChange:n=>o(n,"Files"),ref:j})]})]})})})},De=({massage:t,user:c})=>{const{sender:i,content:u,attachments:d=[],createdAt:j,_id:a}=t,p=(i==null?void 0:i._id)===(c==null?void 0:c._id),f=oe(j).fromNow();return e.jsxs(Ie.div,{initial:{opacity:0,x:"-100%"},whileInView:{opacity:1,x:0},style:{alignSelf:p?"flex-end":"flex-start",backgroundColor:"white",color:"black",borderRadius:"5px",padding:"0.5rem",width:"fit-content"},children:[!p&&e.jsx(L,{color:ae,fontWeight:"600",children:i.name}),u&&e.jsx(L,{children:u}),d.length>0&&d.map((g,m)=>{const o=g.url,n=ie(o);return e.jsx(Le,{children:e.jsxs("a",{href:o,target:"_blank",download:!0,style:{color:"black"},children:[e.jsx($e,{file:n,url:o}),"  "]})},m)}),e.jsx(L,{variant:"caption",color:"GrayText",children:f})]})},Ve=s.memo(De),He=({chatId:t,user:c})=>{var E,I,_,$;s.useRef(null);const i=s.useRef(null),u=s.useRef(null),d=s.useRef(null),j=le(),a=ce(),p=G(),[f,g]=s.useState(""),[m,o]=s.useState([]),[n,l]=s.useState(1),[y,C]=s.useState(null),[h,w]=s.useState(!1),[b,R]=s.useState(!1),x=ue({chatId:t,skip:!t}),v=de({chatId:t,page:n}),S=(I=(E=x==null?void 0:x.data)==null?void 0:E.chat)==null?void 0:I.members,{data:Q,setData:U}=Se(i,(_=v.data)==null?void 0:_.totalPages,n,l,($=v.data)==null?void 0:$.messages),Y=[{isError:x.isError,error:x.error},{isError:v.isError,error:v.error}],q=r=>{r.preventDefault(),f.trim()&&(a.emit(V,{chatId:t,members:S,message:f}),g(""))};s.useEffect(()=>(a.emit(me,{userId:c._id,members:S}),p(ge(t)),()=>{g(""),o([]),l(1),U([]),a.emit(pe,{userId:c._id,members:S})}),[t]),s.useEffect(()=>{u.current&&u.current.scrollIntoView({behavior:"smooth"})},[m]),s.useEffect(()=>{if(x.isError)return j("/")},[]);const J=s.useCallback(r=>{r.chatId===t&&o(M=>[...M,r.message])},[t]),P=s.useCallback(r=>{r.chatId===t&&R(!0)},[t]),W=s.useCallback(r=>{r.chatId===t&&R(!1)},[t]),X=s.useCallback(r=>{if(r.chatId!==t)return;const M={content:r.message,sender:{_id:"kkljlljlilpkl",name:"Admin"},chat:t,createdAt:new Date().toISOString()};o(te=>[...te,M])},[t]),K={[Ce]:X,[V]:J,[H]:P,[O]:W};Re(a,K),Ee(Y);const Z=[...Q,...m],ee=r=>{p(N(!0)),C(r.currentTarget)},se=r=>{g(r.target.value),h||(a.emit(H,{members:S,chatId:t}),w(!0)),d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{a.emit(O,{members:S,chatId:t}),w(!1)},[800])};return x.isLoading?e.jsx(fe,{}):e.jsxs(s.Fragment,{children:[e.jsxs(D,{ref:i,boxSizing:"border-box",padding:"1rem",spacing:"1rem",bgcolor:he,height:"90%",sx:{overflowX:"hidden",overflowY:"auto"},children:[Z.map((r,M)=>e.jsx(Ve,{massage:r,user:c},r._id||`temp-${M}`)),b&&e.jsx(xe,{}),e.jsx("div",{ref:u})]}),e.jsx("form",{style:{height:"10%"},onSubmit:q,children:e.jsxs(D,{direction:"row",height:"100%",padding:"1rem",alignItems:"center",position:"relative",children:[e.jsx(z,{sx:{rotate:"30deg",position:"absolute",left:"1.5rem"},onClick:ee,children:e.jsx(Ae,{})}),e.jsx(je,{placeholder:"Type Massage Here...",value:f,onChange:se}),e.jsx(z,{type:"submit",sx:{backgroundColor:ye,rotate:"-30deg",color:"white",marginLeft:"1rem",padding:"0.5rem","&:hover":{backgroundColor:"error.dark"}},children:e.jsx(Te,{})})]})}),e.jsx(Be,{anchorE1:y,chatId:t})]})},Ke=_e()(He);export{Ke as default};
